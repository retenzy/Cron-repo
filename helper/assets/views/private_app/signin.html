<html>
  <head>
    <link rel="icon" href="../favicon.png" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
      integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
      crossorigin="anonymous"
    />
    <link href="../css/private_login.css" rel="stylesheet" type="text/css" />
    <link rel="icon" href="./favicon.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css"
    />
  </head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!-- Latest compiled JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"
    type="text/javascript"
  ></script>

  <title>Retenzy - Login</title>

  <body>
    <div class="login-page">
      <input type="hidden" name="_token" value="{{csrf_token()}}" />
      <div class="form" id="login_section">
        <div class="title-outer">
          <div class="loading">
            <img class="logo-image" src="../f-logo.png" alt="Retenzy " />
          </div>
        </div>
        <div id="buttons">
          <form class="login-form" onsubmit="loginFunction()">
            <label class="label-login">Enter shop name</label>
            <input
              type="text"
              name="shop_name"
              id="shop"
              required=""
              placeholder="shopname.myshopify.com"
            />
            <label class="label-login">Enter Password</label>
            <div class="password-container">
              <input
                type="password"
                name="password_value"
                id="password"
                required=""
                placeholder="password"
              />
              <div class="toggle-password-top-right">
                <i
                  class="far fa-eye"
                  id="togglePassword"
                  onclick="showPassword()"
                ></i>
              </div>
            </div>
            <div class="error-msg" id="error-msg"></div>
            <div id="login-btn">
              <button class="login-btn" type="login-btn" id="login">
                Login
              </button>
            </div>
            <!-- <p class="ptag"><a class="cursor" id="signup" href="/private/password-reset">Forgot password?</a></p> -->
            <p class="ptag">
              Don't have an account?
              <a class="cursor" id="signup" href="/private/signup">signup</a>
            </p>
          </form>
        </div>
      </div>
    </div>

    <script>
      function loginValidation() {
        let isValid = true;
        let shopName = document.getElementById('shop').value;
        let passWord = document.getElementById('password').value;
        let store = shopName.trim();
        let validate_store = /^(?:)[a-zA-Z0-9\-]*\.myshopify\.com[\/]?/.test(
          store
        );
        if (!validate_store) {
          isValid = false;
          shop.classList.add('error');
          document.getElementById('error-msg').innerHTML =
            '&#9432 shopname is not valid.';
          event.preventDefault();
        } else {
          shop.classList.remove('error');
          if (!passWord.length) {
            isValid = false;
            password.classList.add('error');
            document.getElementById('error-msg').innerHTML = '&#9432 required.';
            event.preventDefault();
          } else {
            password.classList.remove('error');
          }
        }
        return isValid;
      }

      function showPassword() {
        var element = document.getElementById('password');
        if (element.type === 'password') {
          element.type = 'text';
        } else {
          element.type = 'password';
        }
      }

      const loginFunction = async () => {
        event.preventDefault();
        let valid = loginValidation();
        if (!valid) {
          let element = document.getElementById('login-btn');
          if (element) {
            element.innerHTML = `<button class="login-btn" type="login-btn" id="login">Login</button>`;
          }
          return false;
        }
        document.getElementById('login-btn').innerHTML = `
      <button class="buttonload" id="buttonload disabled">
      <i class="fa fa-circle-o-notch fa-spin"></i>
      </button>`;
        let shopname = document.getElementById('shop').value;
        let password = document.getElementById('password').value;
        let payload = {
          shopname: shopname,
          password: password,
        };
        const options = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        };
        let response = await fetch('/auth/private/login', options);
        let data = await response.json();
        if (data.status != 200) {
          document.getElementById('error-msg').innerHTML =
            `&#9432 ${data.message}`;
          let element = document.getElementById('login-btn');
          if (element) {
            element.innerHTML = `<button class="login-btn" type="login-btn" id="login">Login</button>`;
          }
          return false;
        } else {
          document.getElementById('error-msg').innerHTML = ``;
          window.location.href = data.url;
          let element = document.getElementById('login-btn');
          if (element) {
            element.innerHTML = `<button class="login-btn" type="login-btn" id="login">Login</button>`;
          }
        }
      };
    </script>
  </body>
</html>
